name: I am Reviewed ðŸš€

on:
  pull_request:
    types: [opened, reopened, synchronize]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

# Required for Workload Identity Federation and PR comments
permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  REGISTRY: europe-west2-docker.pkg.dev/iamreleased/docker-images
  IMAGE_NAME: pr-review-agent-github

jobs:
  build-and-review:
    name: Build Image and Review PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker europe-west2-docker.pkg.dev

      - name: Set image tags
        id: tags
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)

          echo "tag_pr=${REGISTRY}/${IMAGE_NAME}:pr-${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "tag_pr_sha=${REGISTRY}/${IMAGE_NAME}:pr-${PR_NUMBER}-${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.Github
          push: true
          tags: |
            ${{ steps.tags.outputs.tag_pr }}
            ${{ steps.tags.outputs.tag_pr_sha }}
          cache-from: type=gha,scope=pr-review
          cache-to: type=gha,mode=max,scope=pr-review

      - name: Output image details
        run: |
          echo "âœ… Docker image built and pushed successfully!"
          echo ""
          echo "Image tags:"
          echo "  PR: ${{ steps.tags.outputs.tag_pr }}"
          echo "  PR+SHA: ${{ steps.tags.outputs.tag_pr_sha }}"

      - name: Run Code Review
        run: |
          docker run --rm \
            -e GH_TOKEN="${{ secrets.GITHUB_TOKEN }}" \
            -e REPOSITORY="${{ github.repository }}" \
            -e PR_NUMBER="${{ steps.pr.outputs.number }}" \
            -e GOOGLE_CLOUD_PROJECT="${{ secrets.GOOGLE_CLOUD_PROJECT }}" \
            -e GOOGLE_CLOUD_LOCATION="${{ secrets.GOOGLE_CLOUD_LOCATION }}" \
            -e GOOGLE_CLOUD_CREDENTIALS='${{ secrets.GOOGLE_CLOUD_CREDENTIALS }}' \
            ${{ steps.tags.outputs.tag_pr }}

      - name: Review completed
        run: |
          echo "âœ… PR #${{ steps.pr.outputs.number }} has been reviewed!"
          echo ""
          echo "Used image: ${{ steps.tags.outputs.tag_pr }}"
